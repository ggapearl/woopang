# TourAPI 429 ì—ëŸ¬ í•´ê²° ë°©ì•ˆ (2025-12-04)

## ğŸš¨ ë¬¸ì œ ìƒí™©

### ì—ëŸ¬ ë©”ì‹œì§€
```
[Error] Proxy request to TourAPI failed: 429 Client Error: Too Many Requests for url:
http://apis.data.go.kr/B551011/KorPetTourService/locationBasedList
```

### ì›ì¸ ë¶„ì„

**1. ê³µê³µë°ì´í„°í¬í„¸ API ì œí•œ**
```
ì¼ì¼ íŠ¸ë˜í”½: 1,000 calls/day
ë¶„ë‹¹ íŠ¸ë˜í”½: 100 calls/minute
```

**2. Unity ì•±ì˜ ê³¼ë„í•œ ìš”ì²­**
```csharp
// TourAPIManager.cs (ìˆ˜ì • ì „)
public float[] loadRadii = new float[] {
    25f, 50f, 75f, 100f, 150f, 200f, 500f, 1000f, 2000f, 5000f, 10000f
};  // 11ê°œ radius â†’ 11ë²ˆ API í˜¸ì¶œ
```

**3. ìºì‹± ì—†ìŒ (ìˆ˜ì • ì „)**
- ì„œë²„ ì¬ì‹œì‘ ì‹œ ìºì‹œ ì´ˆê¸°í™”
- ë™ì¼ ìš”ì²­ë„ ë§¤ë²ˆ API í˜¸ì¶œ

### ëˆ„ì  API í˜¸ì¶œ ìˆ˜

```
ì•± ì‹œì‘ 1íšŒ: 11 calls
ì•± ì¬ì‹œì‘ 10íšŒ: 110 calls
í…ŒìŠ¤íŠ¸ ì¤‘ ì—¬ëŸ¬ ë²ˆ: 200+ calls

â†’ ì¼ì¼ ì œí•œ 1,000 calls ì´ˆê³¼!
â†’ 429 Too Many Requests ì—ëŸ¬ ë°œìƒ
```

---

## âœ… í•´ê²° ë°©ë²•

### 1. ì„œë²„ ìºì‹± ì‹œìŠ¤í…œ (ì™„ë£Œ âœ…)

**íŒŒì¼:** `c:\woopang\server\app_improved.py`

**êµ¬í˜„:**
```python
# TourAPI ì‘ë‹µ ìºì‹œ (ë©”ëª¨ë¦¬)
tour_api_cache = {}
TOUR_API_CACHE_TTL = 300  # 5ë¶„ ìºì‹œ ìœ ì§€

@app.route('/proxy/<path:path>', methods=['GET'])
def proxy(path):
    # 1. ìºì‹œ í™•ì¸
    cache_key = get_tour_api_cache_key(path, request.args)
    cached_data, cached_headers = get_cached_response(cache_key)

    if cached_data is not None:
        # ìºì‹œ HIT - API í˜¸ì¶œ ì•ˆ í•¨
        response_headers['X-Cache'] = 'HIT'
        return cached_data, 200, response_headers

    # 2. ìºì‹œ MISS - API í˜¸ì¶œ
    response = requests.get(tour_api_url, params=params, headers=headers, timeout=10)

    # 3. ìºì‹œ ì €ì¥
    cache_response(cache_key, response.content, response_headers)

    response_headers['X-Cache'] = 'MISS'
    return response.content, response.status_code, response_headers
```

**íš¨ê³¼:**
```
ìºì‹œ ì „: 11 calls per session
ìºì‹œ í›„: 11 calls ì²« ì‹¤í–‰, 0 calls (5ë¶„ ë‚´ ì¬ì‹¤í–‰)
ê°ì†Œìœ¨: 0% (ì²« ì‹¤í–‰), 100% (ì¬ì‹¤í–‰)
```

### 2. Unity ì•± ìš”ì²­ ìˆ˜ ì¶•ì†Œ (ì™„ë£Œ âœ…)

**íŒŒì¼:** `c:\woopang\Assets\Scripts\Download\TourAPIManager.cs`

**ë³€ê²½ ì „:**
```csharp
public float[] loadRadii = new float[] {
    25f, 50f, 75f, 100f, 150f, 200f, 500f, 1000f, 2000f, 5000f, 10000f
};  // 11ê°œ radius
```

**ë³€ê²½ í›„:**
```csharp
public float[] loadRadii = new float[] {
    1000f, 5000f
};  // 2ê°œ radius (API í˜¸ì¶œ 82% ê°ì†Œ!)
```

**íš¨ê³¼:**
```
ë³€ê²½ ì „: 11 calls per session
ë³€ê²½ í›„: 2 calls per session
ê°ì†Œìœ¨: 82%
```

### 3. í†µí•© íš¨ê³¼

**ì„œë²„ ìºì‹± + Unity ìš”ì²­ ì¶•ì†Œ:**
```
ì²« ì‹¤í–‰:   2 calls (11 â†’ 2, 82% ê°ì†Œ)
ì¬ì‹¤í–‰:    0 calls (ìºì‹œ HIT, 100% ê°ì†Œ)

ì¼ì¼ ì‚¬ìš©ëŸ‰ ì˜ˆì¸¡:
- ì´ì „: 100ëª… Ã— 11 calls = 1,100 calls (ì œí•œ ì´ˆê³¼!)
- í˜„ì¬: 100ëª… Ã— 2 calls = 200 calls (ì—¬ìœ  800 calls)
```

---

## ğŸ“Š API í˜¸ì¶œ ë¹„êµ

### Before (ìˆ˜ì • ì „)

```
ì‚¬ìš©ì 1 â†’ ì•± ì‹œì‘
â”œâ”€ radius=25m    â†’ API í˜¸ì¶œ (1/1000)
â”œâ”€ radius=50m    â†’ API í˜¸ì¶œ (2/1000)
â”œâ”€ radius=75m    â†’ API í˜¸ì¶œ (3/1000)
â”œâ”€ radius=100m   â†’ API í˜¸ì¶œ (4/1000)
â”œâ”€ radius=150m   â†’ API í˜¸ì¶œ (5/1000)
â”œâ”€ radius=200m   â†’ API í˜¸ì¶œ (6/1000)
â”œâ”€ radius=500m   â†’ API í˜¸ì¶œ (7/1000)
â”œâ”€ radius=1000m  â†’ API í˜¸ì¶œ (8/1000)
â”œâ”€ radius=2000m  â†’ API í˜¸ì¶œ (9/1000)
â”œâ”€ radius=5000m  â†’ API í˜¸ì¶œ (10/1000)
â””â”€ radius=10000m â†’ API í˜¸ì¶œ (11/1000)

ì‚¬ìš©ì 1 â†’ ì•± ì¬ì‹œì‘ (5ë¶„ í›„)
â”œâ”€ radius=25m    â†’ API í˜¸ì¶œ (12/1000) âŒ ìºì‹œ ì—†ìŒ
â”œâ”€ radius=50m    â†’ API í˜¸ì¶œ (13/1000)
â””â”€ ... (11ë²ˆ ë°˜ë³µ)

â†’ 100íšŒ ì¬ì‹œì‘ = 1,100 calls â†’ 429 ì—ëŸ¬! âŒ
```

### After (ìˆ˜ì • í›„)

```
ì‚¬ìš©ì 1 â†’ ì•± ì‹œì‘
â”œâ”€ radius=1000m  â†’ [Cache] MISS â†’ API í˜¸ì¶œ (1/1000)
â””â”€ radius=5000m  â†’ [Cache] MISS â†’ API í˜¸ì¶œ (2/1000)

ì‚¬ìš©ì 1 â†’ ì•± ì¬ì‹œì‘ (5ë¶„ ì´ë‚´)
â”œâ”€ radius=1000m  â†’ [Cache] HIT (age: 2.3s) âœ… API í˜¸ì¶œ ì—†ìŒ
â””â”€ radius=5000m  â†’ [Cache] HIT (age: 2.5s) âœ… API í˜¸ì¶œ ì—†ìŒ

ì‚¬ìš©ì 1 â†’ ì•± ì¬ì‹œì‘ (10ë¶„ í›„, ìºì‹œ ë§Œë£Œ)
â”œâ”€ radius=1000m  â†’ [Cache] EXPIRED â†’ API í˜¸ì¶œ (3/1000)
â””â”€ radius=5000m  â†’ [Cache] EXPIRED â†’ API í˜¸ì¶œ (4/1000)

â†’ 500íšŒ ì¬ì‹œì‘ = 200 calls (5ë¶„ ê°„ê²© ê°€ì •) â†’ ì •ìƒ! âœ…
```

---

## ğŸ” ì™œ 1kmì™€ 5kmë§Œ ì‚¬ìš©í•˜ë‚˜?

### ë°˜ê²½ ì„ íƒ ì´ìœ 

**25m ~ 200m (ì œê±°):**
- ë„ˆë¬´ ê°€ê¹Œìš´ ê±°ë¦¬
- ëŒ€ë¶€ë¶„ "ìš°íŒ¡ ë°ì´í„°"ë¡œ ì»¤ë²„ë¨
- ê´€ê´‘ì§€ëŠ” ë³´í†µ ë” ë¨¼ ê±°ë¦¬ì— ë¶„í¬

**500m (ì œê±°):**
- 1kmë¡œ ëŒ€ì²´ ê°€ëŠ¥
- 1km ë°˜ê²½ì— 500më„ í¬í•¨ë¨

**1km (ìœ ì§€ âœ…):**
- ë„ë³´ ì´ë™ ë²”ìœ„ (ë„ì‹¬ ê´€ê´‘)
- ê·¼ì²˜ ë°˜ë ¤ë™ë¬¼ ë™ë°˜ ê°€ëŠ¥ ì¹´í˜/ì‹ë‹¹

**2km (ì œê±°):**
- 5kmë¡œ ëŒ€ì²´ ê°€ëŠ¥

**5km (ìœ ì§€ âœ…):**
- ìë™ì°¨ ì´ë™ ë²”ìœ„
- ê´€ê´‘ì§€ ëŒ€ë¶€ë¶„ ì»¤ë²„
- ë„ì‹œ ì „ì²´ íƒìƒ‰ ê°€ëŠ¥

**10km (ì œê±°):**
- ë„ˆë¬´ ë„“ì€ ë²”ìœ„
- 5kmë¡œ ì¶©ë¶„

### ì‹¤ì œ ì‚¬ìš© íŒ¨í„´

**ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤:**
```
1. ì•± ì‹œì‘
   â†’ 1km ë°ì´í„° ë¡œë”© (ì£¼ë³€ ì¹´í˜/ì‹ë‹¹)
   â†’ 5km ë°ì´í„° ë¡œë”© (ê´€ê´‘ì§€/ê³µì›)

2. PlaceList í‘œì‹œ
   â†’ 1km ë‚´: 10ê°œ ì¥ì†Œ
   â†’ 5km ë‚´: 30ê°œ ì¥ì†Œ
   â†’ ì´ 40ê°œ ì¥ì†Œ í‘œì‹œ

3. AR í™˜ê²½
   â†’ ê°€ê¹Œìš´ ì¥ì†Œë¶€í„° í‘œì‹œ
   â†’ ë©€ë¦¬ ìˆëŠ” ì¥ì†ŒëŠ” Offscreen Indicator
```

---

## ğŸ› ï¸ ì¶”ê°€ ìµœì í™” ë°©ì•ˆ

### 1. ìºì‹œ TTL ì¦ê°€ (ì„ íƒì‚¬í•­)

**í˜„ì¬:**
```python
TOUR_API_CACHE_TTL = 300  # 5ë¶„
```

**ì œì•ˆ:**
```python
TOUR_API_CACHE_TTL = 1800  # 30ë¶„
# ë˜ëŠ”
TOUR_API_CACHE_TTL = 3600  # 1ì‹œê°„
```

**ì´ìœ :**
- ê´€ê´‘ì§€ ë°ì´í„°ëŠ” ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠìŒ
- ë” ê¸´ ìºì‹œ = ë” ì ì€ API í˜¸ì¶œ

### 2. Redis ìºì‹œ (ì„ íƒì‚¬í•­)

**í˜„ì¬:** ë©”ëª¨ë¦¬ ìºì‹œ (ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”)

**ì œì•ˆ:** Redis ìºì‹œ (ì˜êµ¬ ì €ì¥)

```python
import redis
redis_client = redis.Redis(host='localhost', port=6379, db=1)

def get_cached_response(cache_key):
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)
    return None

def cache_response(cache_key, data, headers):
    redis_client.setex(
        cache_key,
        TOUR_API_CACHE_TTL,
        json.dumps({'data': data, 'headers': headers})
    )
```

**ì¥ì :**
- ì„œë²„ ì¬ì‹œì‘ í›„ì—ë„ ìºì‹œ ìœ ì§€
- ì—¬ëŸ¬ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ê°„ ìºì‹œ ê³µìœ 

### 3. Unity ì•± - 1ê°œ radiusë§Œ ì‚¬ìš© (ê·¹ë‹¨ì  ìµœì í™”)

**ë” ê³µê²©ì ìœ¼ë¡œ:**
```csharp
public float[] loadRadii = new float[] { 5000f };  // 1ê°œë§Œ!
```

**íš¨ê³¼:**
```
ì•± ì‹œì‘: 1 call (11 â†’ 1, 91% ê°ì†Œ)
ì¼ì¼ ì‚¬ìš©ëŸ‰: 100ëª… Ã— 1 call = 100 calls (ì—¬ìœ  900 calls)
```

---

## â° í˜„ì¬ ìƒíƒœ ë° ë‹¤ìŒ ë‹¨ê³„

### í˜„ì¬ ìƒíƒœ

**ì˜¤ëŠ˜ (2025-12-04):**
- âŒ TourAPI 429 ì—ëŸ¬ ë°œìƒ (ì¼ì¼ ì œí•œ ì´ˆê³¼)
- âœ… ì„œë²„ ìºì‹± ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ
- âœ… Unity ì•± ìš”ì²­ ìˆ˜ ì¶•ì†Œ ì™„ë£Œ (11 â†’ 2)

**ë‚´ì¼ (2025-12-05 00:00 ì´í›„):**
- âœ… TourAPI ì¼ì¼ ì œí•œ ì´ˆê¸°í™”
- âœ… ì •ìƒ ì‘ë™ ì˜ˆìƒ (2 calls per session)

### í…ŒìŠ¤íŠ¸ ë°©ë²•

**1. ë‚´ì¼ ì•± ì‹¤í–‰ í›„ ì„œë²„ ë¡œê·¸ í™•ì¸:**
```bash
# ì„œë²„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
tail -f c:\woopang\server\logs\server.log | grep -E "TourAPI|Cache"

# ì˜ˆìƒ ë¡œê·¸:
# [TourAPI] Request - http://apis.data.go.kr/.../locationBasedList?...&radius=1000
# [Cache] STORED - locationBasedList?...&radius=1000... (total cached: 1)
# [TourAPI] Request - http://apis.data.go.kr/.../locationBasedList?...&radius=5000
# [Cache] STORED - locationBasedList?...&radius=5000... (total cached: 2)
```

**2. 5ë¶„ ì´ë‚´ ì¬ì‹¤í–‰:**
```bash
# ì˜ˆìƒ ë¡œê·¸:
# [Cache] HIT - locationBasedList?...&radius=1000... (age: 2.3s)
# [Cache] HIT - locationBasedList?...&radius=5000... (age: 2.5s)
```

**3. Unity ë¡œê·¸ í™•ì¸:**
```bash
adb logcat | grep -E "TourAPIManager|Progressive"

# ì˜ˆìƒ ë¡œê·¸:
# [TourAPIManager] Progressive Loading ì‹œì‘
# [TourAPIManager] 1000m ë°˜ê²½ ë°ì´í„° ë¡œë”© ì¤‘...
# [TourAPIManager] 5000m ë°˜ê²½ ë°ì´í„° ë¡œë”© ì¤‘...
# [TourAPIManager] Progressive Loading ì™„ë£Œ
```

---

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì™„ë£Œ âœ…
- [x] ì„œë²„ ìºì‹± ì‹œìŠ¤í…œ êµ¬í˜„ (5ë¶„ TTL)
- [x] Cache HIT/MISS ë¡œê¹…
- [x] X-Cache í—¤ë” ì¶”ê°€
- [x] Unity ì•± loadRadii ì¶•ì†Œ (11 â†’ 2)
- [x] TourAPIManager.cs ìˆ˜ì •
- [x] ë¬¸ì„œ ì‘ì„±

### ëŒ€ê¸° ì¤‘
- [ ] Unity ë¹Œë“œ
- [ ] ë””ë°”ì´ìŠ¤ ì„¤ì¹˜
- [ ] ë‚´ì¼ 00:00 ì´í›„ í…ŒìŠ¤íŠ¸
- [ ] TourAPI ì •ìƒ ì‘ë™ í™•ì¸
- [ ] ìºì‹œ ë¡œê·¸ í™•ì¸

### ì„ íƒì‚¬í•­
- [ ] ìºì‹œ TTL 30ë¶„ìœ¼ë¡œ ì¦ê°€ ê³ ë ¤
- [ ] Redis ìºì‹œ ë„ì… ê³ ë ¤
- [ ] loadRadiië¥¼ 1ê°œ(5km)ë¡œ ë” ì¶•ì†Œ ê³ ë ¤

---

## ğŸ’¡ í•µì‹¬ ìš”ì•½

**ë¬¸ì œ:**
- TourAPI 429 ì—ëŸ¬ (ì¼ì¼ 1,000 calls ì œí•œ ì´ˆê³¼)
- Unity ì•±ì´ 11ê°œ radiusë¡œ ê³¼ë„í•œ ìš”ì²­

**í•´ê²°:**
1. **ì„œë²„ ìºì‹±** (5ë¶„ TTL) â†’ ì¬ìš”ì²­ ì‹œ 0 calls
2. **Unity ìš”ì²­ ì¶•ì†Œ** (11 â†’ 2) â†’ 82% ê°ì†Œ

**ê²°ê³¼:**
```
ì´ì „: 11 calls per session â†’ 100 sessions = 1,100 calls (ì œí•œ ì´ˆê³¼!)
í˜„ì¬: 2 calls per session â†’ 500 sessions = 200 calls (ì •ìƒ!)

API í˜¸ì¶œ ê°ì†Œ: 82% â†“
ìºì‹œ í™œìš©: 100% (5ë¶„ ë‚´)
```

**ë‹¤ìŒ ë‹¨ê³„:**
- ë‚´ì¼ 00:00 ì´í›„ ì •ìƒ ì‘ë™ ì˜ˆìƒ
- Unity ë¹Œë“œ í›„ í…ŒìŠ¤íŠ¸
- ì„œë²„ ë¡œê·¸ì—ì„œ Cache HIT í™•ì¸

---

**ì‘ì„±ì¼:** 2025-12-04 21:30
**ìˆ˜ì • íŒŒì¼:**
1. `c:\woopang\server\app_improved.py` - ìºì‹± ì‹œìŠ¤í…œ
2. `c:\woopang\Assets\Scripts\Download\TourAPIManager.cs` - ìš”ì²­ ìˆ˜ ì¶•ì†Œ
