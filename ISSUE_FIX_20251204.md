# PlaceList 표시 문제 및 로딩 스피너 수정 (2025-12-04)

## 🔍 문제 분석

### 문제 1: PlaceList가 표시되지 않음

**로그 증거:**
```
[PlaceListManager] 리스트 업데이트 - 전체 데이터: 우팡=0, TourAPI=0, 필터링 후 표시=0
```

**AR 오브젝트는 정상 생성:**
```
[DataManager] Cube 풀에서 오브젝트 가져옴: Place_ID_cube (50+개)
[DataManager] GLB 로딩 성공 - ID: 166, 160
[DataManager] ===== 점진적 로딩 완료 =====
```

### 근본 원인 발견

#### DataManager.cs 코드 흐름:
```
1. FetchDataProgressively()
   └─ 서버에서 데이터 받아옴 ✅

2. FetchDataFromServerForTier()
   └─ JSON 파싱 성공 ✅
   └─ newPlaces 리스트에 추가 ✅

3. CreateObjectFromData(place)
   └─ spawnedObjects[place.id] = newObj ✅ (AR 오브젝트용)
   └─ placeDataMap[place.id] = place ❌ 누락!
```

#### PlaceListManager.cs가 데이터를 못 가져오는 이유:
```csharp
// PlaceListManager.UpdateUI()
var woopangPlaces = dataManager.GetPlaceDataMap().Values.ToList();
// GetPlaceDataMap()이 빈 Dictionary 반환 → Count = 0
```

### 문제 2: 로딩 스피너가 표시되지 않음

**주석 처리된 코드:**
```csharp
// ImageDisplayController.cs

// Line 51:
// ShowSpinner(true); // 디버깅을 위해 주석 처리

// Line 99:
// ShowSpinner(false); // 디버깅을 위해 주석 처리

// Line 281:
// ShowSpinner(false); // 디버깅을 위해 주석 처리
```

**영향:**
- 텍스처 로딩 중 스피너가 표시되지 않음
- 사용자가 로딩 상태를 알 수 없음
- 로딩 완료 후에도 큐브가 숨겨진 상태로 남을 수 있음

---

## ✅ 해결 방법

### 수정 1: DataManager.cs - placeDataMap 추가

**CreateObjectFromData() 수정:**
```csharp
// Before (Line 408-415):
if (SetupObjectComponents(newObj, place))
{
    spawnedObjects[place.id] = newObj;
}
else
{
    ReturnToPool(newObj, place.model_type);
}

// After (Line 408-417):
if (SetupObjectComponents(newObj, place))
{
    spawnedObjects[place.id] = newObj;
    placeDataMap[place.id] = place; // ⭐ PlaceListManager가 사용하는 데이터 맵에 추가
    Debug.Log($"[DEBUG_DATA] placeDataMap에 추가 완료 - ID: {place.id}, 현재 맵 크기: {placeDataMap.Count}");
}
else
{
    ReturnToPool(newObj, place.model_type);
}
```

**UpdateExistingObject() 수정:**
```csharp
// Before (Line 420-422):
private void UpdateExistingObject(PlaceData place, GameObject existingObj)
{
    SetupObjectComponents(existingObj, place);
}

// After (Line 420-424):
private void UpdateExistingObject(PlaceData place, GameObject existingObj)
{
    SetupObjectComponents(existingObj, place);
    placeDataMap[place.id] = place; // ⭐ 업데이트된 데이터도 맵에 반영
}
```

### 수정 2: ImageDisplayController.cs - 스피너 활성화

**SetBaseMap() 수정:**
```csharp
// Before (Line 50-53):
// 로딩 시작: 스피너 표시, 큐브 숨김
// ShowSpinner(true); // 디버깅을 위해 주석 처리

StartCoroutine(LoadBaseMapTexture(imageUrl));

// After (Line 50-53):
// 로딩 시작: 스피너 표시, 큐브 숨김
ShowSpinner(true); // ⭐ 스피너 활성화

StartCoroutine(LoadBaseMapTexture(imageUrl));
```

**LoadBaseMapTexture() finally 블록 수정:**
```csharp
// Before (Line 95-101):
finally
{
    Debug.Log("[DEBUG_SPINNER] 로딩 코루틴 종료 -> 스피너 끔 (finally)");
    // ShowSpinner(false); // 디버깅을 위해 주석 처리
    currentBaseMapCoroutine = null;
}

// After (Line 95-101):
finally
{
    Debug.Log("[DEBUG_SPINNER] 로딩 코루틴 종료 -> 스피너 끔 (finally)");
    ShowSpinner(false); // ⭐ 스피너 비활성화
    currentBaseMapCoroutine = null;
}
```

**ClearImages() 수정:**
```csharp
// Before (Line 279-281):
// 코루틴이 중단되면 ShowSpinner(false)가 호출되지 않아 큐브가 꺼진 채로 남을 수 있음.
// 따라서 여기서 강제로 초기화해줘야 함.
// ShowSpinner(false); // 디버깅을 위해 주석 처리

// After (Line 279-281):
// 코루틴이 중단되면 ShowSpinner(false)가 호출되지 않아 큐브가 꺼진 채로 남을 수 있음.
// 따라서 여기서 강제로 초기화해줘야 함.
ShowSpinner(false); // ⭐ 스피너 강제 비활성화
```

---

## 📊 예상 결과

### PlaceList 정상 표시

**Before:**
```
[PlaceListManager] 데이터 개수 - 우팡: 0, TourAPI: 0
[PlaceListManager] 리스트 업데이트 - 전체 데이터: 우팡=0, TourAPI=0, 필터링 후 표시=0
```

**After (예상):**
```
[DEBUG_DATA] placeDataMap에 추가 완료 - ID: 123, 현재 맵 크기: 1
[DEBUG_DATA] placeDataMap에 추가 완료 - ID: 124, 현재 맵 크기: 2
...
[DEBUG_DATA] placeDataMap에 추가 완료 - ID: 200, 현재 맵 크기: 78

[PlaceListManager] 데이터 개수 - 우팡: 78, TourAPI: 15
[PlaceListManager] 우팡데이터 처리 - 전체: 78, 필터링됨: 5, 추가됨: 73
[PlaceListManager] 리스트 업데이트 - 전체 데이터: 우팡=78, TourAPI=15, 필터링 후 표시=88
```

### 로딩 스피너 동작

**시퀀스:**
1. `SetBaseMap()` 호출
2. `ShowSpinner(true)` → 스피너 표시 + 큐브 숨김
3. 텍스처 로딩 중 (최대 20초)
4. 로딩 완료
5. `ShowSpinner(false)` → 스피너 숨김 + 큐브 표시

---

## 🔧 디버깅 가이드

### PlaceList 표시 확인

**1. placeDataMap 크기 확인:**
```
[DEBUG_DATA] placeDataMap에 추가 완료 - ID: X, 현재 맵 크기: N
```
- N > 0 이어야 함
- N = 0 이면 CreateObjectFromData()가 호출되지 않음

**2. PlaceListManager 데이터 개수 확인:**
```
[PlaceListManager] 데이터 개수 - 우팡: X, TourAPI: Y
```
- X > 0 또는 Y > 0 이어야 함
- 모두 0이면 GetPlaceDataMap()에서 빈 Dictionary 받음

**3. 필터 상태 확인:**
```
[PlaceListManager] 필터 상태 - woopangData=true, petFriendly=true, alcohol=true, publicData=true
```
- woopangData=true 또는 publicData=true 확인
- 모두 false면 모든 데이터 필터링됨

### 로딩 스피너 동작 확인

**1. 스피너 생성 로그:**
```
[DEBUG_SPINNER] ShowSpinner(true)
[DEBUG_SPINNER] Renderer X 상태 변경: false (큐브 숨김)
```

**2. 텍스처 로딩 로그:**
```
[DEBUG_IMAGE] Loading BaseMap: https://woopang.com/...
[DEBUG_SPINNER] 로딩 완료. 경과: 1.23s, 목표: 10s, 추가 대기: 8.77s
```

**3. 스피너 종료 로그:**
```
[DEBUG_SPINNER] 로딩 코루틴 종료 -> 스피너 끔 (finally)
[DEBUG_SPINNER] ShowSpinner(false)
[DEBUG_SPINNER] Renderer X 상태 변경: true (큐브 표시)
```

---

## ⚠️ 잠재적 문제

### 1. 스피너가 AR 오브젝트 생성을 방해할 수 있음

**증상:**
- 스피너 활성화 시 AR 오브젝트가 생성되지 않음
- SetupObjectComponents()가 false 반환

**원인 추정:**
- ShowSpinner(true)가 Renderer를 끔
- SetupObjectComponents()가 Renderer 상태를 체크할 수 있음

**해결 방법:**
- ShowSpinner() 로직 확인
- Renderer 활성화 타이밍 조정
- 필요시 스피너를 별도 GameObject로 분리

### 2. 스피너 duration (10초) 너무 길 수 있음

**현재 설정:**
```csharp
public float spinnerDuration = 10f; // 10초
```

**실제 로딩 시간:**
```
[DEBUG_SPINNER] 로딩 완료. 경과: 1.23s
```

**개선 방안:**
- spinnerDuration을 3~5초로 줄임
- 또는 최소 duration 설정 제거 (실제 로딩 시간만 사용)

---

## 📝 테스트 체크리스트

### PlaceList 표시 테스트

- [ ] ListPanel 열기
- [ ] 로그 확인: `placeDataMap에 추가 완료` (N > 0)
- [ ] 로그 확인: `데이터 개수 - 우팡: X` (X > 0)
- [ ] 리스트에 장소들이 표시되는가?
- [ ] 거리순으로 정렬되는가?
- [ ] 필터 토글 동작 확인

### 로딩 스피너 테스트

- [ ] AR 오브젝트 생성 시작
- [ ] 스피너가 표시되는가?
- [ ] 큐브가 숨겨지는가?
- [ ] 로딩 완료 후 스피너가 사라지는가?
- [ ] 로딩 완료 후 큐브가 표시되는가?
- [ ] AR 오브젝트가 정상 생성되는가?

---

## 🚀 배포

**커밋:**
```bash
git commit -m "Fix PlaceList display issue and re-enable loading spinner"
```

**빌드 & 테스트:**
1. Unity에서 WP_1201 씬 빌드
2. Android 디바이스에 설치
3. AR 세션 시작
4. ListPanel 열어서 데이터 확인
5. 로딩 스피너 동작 확인

---

**작성일:** 2025-12-04
**커밋:** 64d3439 - Fix PlaceList display issue and re-enable loading spinner
